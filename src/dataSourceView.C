#include "dataSourceView.h"DataSourceView::DataSourceView( WContainerWidget* parent ):WContainerWidget(parent) {	hbox_ = new WHBoxLayout();		//left	WContainerWidget* container = new WContainerWidget( );	navtree_ = new WTreeView( container );	navtree_->setAttributeValue      ("oncontextmenu",       "event.cancelBubble = true; event.returnValue = false; return false;");	navtree_->resize(200, WLength::Auto);    navtree_->setSelectionMode(SingleSelection);    navtree_->expandToDepth(1);    navtree_->selectionChanged().connect(this, &DataSourceView::navTreeSelectChanged);		container->addWidget( new WBreak( container ) );	addbtn_ = new WPushButton("增加", container);	editbtn_ = new WPushButton("修改", container);	delbtn_ = new WPushButton("删除", container);	hbox_->addWidget( container, 0 );	//right	contents_ = new WStackedWidget( );	//summary	tabview_ = new WTableView( contents_ );	tabview_->setMargin(10, Top | Bottom);	tabview_->setAlternatingRowColors(true);	//tabview_->setSelectionMode(ExtendedSelection);	//tabview_->setDragEnabled(true);	tabview_->setColumnWidth(0, 100);	//名称	tabview_->setColumnWidth(1, 150);	//类型	tabview_->setColumnWidth(2, 100);	//地址	tabview_->setColumnWidth(3, 60);	//端口	tabview_->setColumnWidth(4, 100);	//实例	tabview_->setColumnWidth(5, 100);	//用户	tabview_->setColumnWidth(6, 100);	//密码	tabview_->setColumnWidth(7, 100);	//是否启用连接池	contents_->addWidget( tabview_ );	//detail	detail_ = new WTable(contents_);	contents_->addWidget( detail_ );	//input form	formTable_ = new WTable( contents_ );	contents_->addWidget( formTable_ );	//	hbox_->addWidget( contents_, 1 );		//init data	navTreeModel_ = new WStandardItemModel( 0, 1, container );	summaryTableModel_ = new WStandardItemModel( 0, 0, contents_ );	//	readDataSourceTypes();	readDataSourceItems();	renderTreeView();	renderSummaryTable();}int DataSourceView::readDataSourceTypes(){	DSType one;		dsTypes_.clear();	one.name_ = "Oracle 11G";	one.version_ = "11.2";	one.desc_ = "甲骨文数据库 11G R2";	one.driver_ = "jdbc driver...";	dsTypes_[one.name_] = one;	////	one.name_ = "Oracle 10G";	one.version_ = "10.2";	one.desc_ = "甲骨文数据库 10G R2";	dsTypes_[one.name_] = one;	////	one.name_ = "MySQL 5.1";	one.version_ = "5.1";	one.desc_ = "MySQL关系数据库 V5.1";	dsTypes_[one.name_] = one;	////	one.name_ = "TRS 5";	one.version_ = "5";	one.desc_ = "TRS全文数据库 V5";	dsTypes_[one.name_] = one;	return dsTypes_.size();}int DataSourceView::readDataSourceItems(){	int count=0;	DSItem  item;	map<string,map<string,DSItem>>::iterator it;		////	item.name_ = "QBK";	item.type_ = "Oracle 11G";	item.ip_ = "192.168.56.131";	item.port_ = 1521;	item.instance_ = "ORCL";	item.user_ = "qbk";	item.passwd_ = "d1e2l3l4";	item.poolable_ = true;		it = dsTree_.find( item.type_ );	if( it != dsTree_.end() )	{		it->second[item.name_] = item;	}	else	{		map<string,DSItem> items;		items[item.name_] = item;		dsTree_[item.type_] = items;	}	count++;	////	item.name_ = "QBK_BAK";	item.type_ = "Oracle 11G";	item.ip_ = "192.168.56.132";	item.port_ = 1521;	item.instance_ = "ORCL";	item.user_ = "qbk";	item.passwd_ = "d1e2l3l4";	item.poolable_ = true;		it = dsTree_.find( item.type_ );	if( it != dsTree_.end() )	{		it->second[item.name_] = item;	}	else	{		map<string,DSItem> items;		items[item.name_] = item;		dsTree_[item.type_] = items;	}	count++;	////	item.name_ = "ZLK";	item.type_ = "TRS 5";	item.ip_ = "192.168.56.131";	item.port_ = 8888;	item.instance_ = "_main_";	item.user_ = "system";	item.passwd_ = "d1e2l3l4";	item.poolable_ = true;		it = dsTree_.find( item.type_ );	if( it != dsTree_.end() )	{		it->second[item.name_] = item;	}	else	{		map<string,DSItem> items;		items[item.name_] = item;		dsTree_[item.type_] = items;	}	count++;	return count;}void DataSourceView::renderTreeView(){	WStandardItem* row1, *row2;	map<string,map<string,DSItem>>::iterator it;		navTreeModel_->clear();	for( it = dsTree_.begin(); it!=dsTree_.end(); it++ )	{		row1 = new WStandardItem( it->first );		row1->setFlags(row1->flags().clear(ItemIsSelectable));		row1->setIcon("icons/folder.gif");		navTreeModel_->appendRow( row1 ); 				map<string,DSItem>::iterator it1;		for( it1=it->second.begin(); it1!=it->second.end(); it1++ )		{			row2 = WStandardItem( it1->first );			row1->appendRow( row2 );		}	}	navTreeModel_->setHeaderData(0, Horizontal, boost::any(std::string("分类导航")));	navtree_->setModel( navTreeModel_ );	navtree_->select( navTreeModel_->index(0, 0, navTreeModel_->index(0, 0)) );}void navTreeSelectChanged() {    if (navtree_->selectedIndexes().empty())      return;    WModelIndex selected = *navtree_->selectedIndexes().begin();    boost::any d = selected.data(DisplayRole);    if (!d.empty()) {		std::string dsItem = boost::any_cast<std::string>(d);		//display the detail message at right panel....    }  }  void DataSourceView::renderSummaryTable(){	int count;	map<string,map<string,DSItem>>::iterator it;		summaryTableModel_->clear();	summaryTableModel_->setHeaderData( 0, boost::any(std::string("名称")));	summaryTableModel_->setHeaderData( 1, boost::any(std::string("类型")));	summaryTableModel_->setHeaderData( 2, boost::any(std::string("地址")));	summaryTableModel_->setHeaderData( 3, boost::any(std::string("端口")));	summaryTableModel_->setHeaderData( 4, boost::any(std::string("实例")));	summaryTableModel_->setHeaderData( 5, boost::any(std::string("用户")));	summaryTableModel_->setHeaderData( 6, boost::any(std::string("密码")));	summaryTableModel_->setHeaderData( 7, boost::any(std::string("连接池")));		for( it=dsTree_.begin(); it!=dsTree_.end(); it++ )	{		map<string,DSItem>::iterator it1;		for( it1=it->second.begin(); it1!=it->second.end(); it1++ )		{			count = summaryTableModel_->rowCount();			summaryTableModel_->insertRows( count,				it1->first );			summaryTableModel_->setData( count, 0, boost::any( it1->second.type_ ) );			summaryTableModel_->setData( count, 1, boost::any( it1->second.type_ ) );			summaryTableModel_->setData( count, 2, boost::any( it1->second.ip_ ) );			summaryTableModel_->setData( count, 3, boost::any( it1->second.port_ ) );			summaryTableModel_->setData( count, 4, boost::any( it1->second.instance_ ) );			summaryTableModel_->setData( count, 5, boost::any( it1->second.user_ ) );			summaryTableModel_->setData( count, 6, boost::any( it1->second.passwd_ ) );			summaryTableModel_->setData( count, 7, boost::any( it1->second.poolable_ ) );		}	}	tabview_->setModel(summaryTableModel_);	////	contents_->setCurrentIndex(0);}void DataSourceView::renderDetail( string dsType, string dsName ){	detail_->clear();	WTableCell *cell = detail_->elementAt(0, 0);	cell->addWidget(new Wt::WText("详细信息"));	cell->setColumnSpan(2);	detail_->elementAt(1, 0)->addWidget(new Wt::WText(" "));	detail_->elementAt(1, 1)->addWidget(new Wt::WText(" "));		////	DSItem &item = dsTree_[dsType][dsName];	DSType &tp = dsTypes_[dsType];	detail_->elementAt(2, 0)->addWidget(new Wt::WText("名称:"));	detail_->elementAt(2, 1)->addWidget(new Wt::WText(item.name_));	detail_->elementAt(3, 0)->addWidget(new Wt::WText("类型:"));	detail_->elementAt(3, 1)->addWidget(new Wt::WText(tp.name_+tp.version_));	detail_->elementAt(4, 0)->addWidget(new Wt::WText("地址:"));	detail_->elementAt(4, 1)->addWidget(new Wt::WText(item.ip_));	detail_->elementAt(5, 0)->addWidget(new Wt::WText("端口:"));	detail_->elementAt(5, 1)->addWidget(new Wt::WText(item.port_));	detail_->elementAt(6, 0)->addWidget(new Wt::WText("实例:"));	detail_->elementAt(6, 1)->addWidget(new Wt::WText(item.instance_));	detail_->elementAt(7, 0)->addWidget(new Wt::WText("帐号:"));	detail_->elementAt(7, 1)->addWidget(new Wt::WText(item.user_));	detail_->elementAt(8, 0)->addWidget(new Wt::WText("密码:"));	detail_->elementAt(8, 1)->addWidget(new Wt::WText(item.passwd_));	detail_->elementAt(9, 0)->addWidget(new Wt::WText("连接池:"));	detail_->elementAt(9, 1)->addWidget(new Wt::WText(item.poolable_));		////	contents_->setCurrentIndex(1);}void DataSourceView::renderInputForm( string dsType, string dsName ){	formTable_->clear();	//1	WTableCell *cell = detail_->elementAt(0, 0);	cell->addWidget(new Wt::WText("填写数据源"));	cell->setColumnSpan(2);	//2	cell = detail_->elementAt(1, 0);	cell->addWidget(new Wt::WText(" "));	cell->setColumnSpan(2);	//3	detail_->elementAt( 2, 0)->addWidget(new WText("名称:"));	WLineEdit* nameEdit = new WLineEdit( dsName, detail_->elementAt( 2, 1));	nameEdit->resize(WLength(100), WLength::Auto);	//4	detail_->elementAt( 3, 0)->addWidget(new WText("类型:"));	WComboBox *typesCombox = new WComboBox( detail_->elementAt( 3, 1));	typesCombox->resize(WLength(100), WLength::Auto);	map<string,DSType>::iterator it;	for( it = dsTypes_.begin(); it!=dsTypes_.end(); it++ )	{		typesCombox->addItem( it->first );	}	typesCombox->setCurrentIndex( typesCombox->findText( dsType ) );	//5	DSItem* pItem=NULL;	if( !dsName.empty() )	{		pItem = &(dsTree_[dsType][dsName]);	}	detail_->elementAt( 4, 0)->addWidget(new WText("地址:"));	WLineEdit* ipEdit = new WLineEdit( detail_->elementAt( 4, 1) );	ipEdit->resize(WLength(100), WLength::Auto);	if( pItem )		ipEdit->setText( pItem->ip_ );	//6	detail_->elementAt( 5, 0)->addWidget(new WText("端口:"));	WLineEdit* portEdit = new WLineEdit( detail_->elementAt( 5, 1) );	portEdit->resize(WLength(100), WLength::Auto);	if( pItem )		portEdit->setText( pItem->port_ );	//7	detail_->elementAt( 6, 0)->addWidget(new WText("实例(目录):"));	WLineEdit* instEdit = new WLineEdit( detail_->elementAt( 6, 1) );	instEdit->resize(WLength(100), WLength::Auto);	if( pItem )		instEdit->setText( pItem->instance_ );	//8	detail_->elementAt( 7, 0)->addWidget(new WText("用户:"));	WLineEdit* userEdit = new WLineEdit( detail_->elementAt( 7, 1) );	userEdit->resize(WLength(100), WLength::Auto);	if( pItem )		userEdit->setText( pItem->user_ );	//9	detail_->elementAt( 8, 0)->addWidget(new WText("密码:"));	WLineEdit* passwdEdit = new WLineEdit( detail_->elementAt( 8, 1) );	passwdEdit->resize(WLength(100), WLength::Auto);	if( pItem )		passwdEdit->setText( pItem->instance_ );	//10	detail_->elementAt( 9, 0)->addWidget(new WText(""));	WCheckBox *poolBox = new WCheckBox( "启用连接池", detail_->elementAt( 9, 1) );	poolBox->resize(WLength(100), WLength::Auto);	if( pItem && pItem->poolable_ )		poolBox->checkState( Checked  );	else		poolBox->checkState( Unchecked );	//11	cell = detail_->elementAt( , 0);	cell->addWidget(new Wt::WText(" "));	cell->setColumnSpan(2);	//12	detail_->elementAt( , 0)->addWidget(new WPushButton("注册"));	detail_->elementAt( , 1)->addWidget(new WPushButton("撤销"));		////	contents_->setCurrentIndex(2);}